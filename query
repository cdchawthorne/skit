#!/usr/bin/env zsh

IRCPATH=${HOME}/utilities/irc
IRCSHADOW=${HOME}/utilities/irc_shadow
UPDATED_FILES=${IRCPATH}/updated.txt

builtin cd ${IRCPATH}

if [[ ! -f ${UPDATED_FILES} ]]; then
    touch ${UPDATED_FILES}
fi

for outfile in $(find . -newer ${UPDATED_FILES} -name 'out'); do
    re1='&bitlbee|(chat.freenode.net|localhost)/out'
    grep -Ev ${re1} <<< ${outfile} &> /dev/null || continue

    if [[ -f ${IRCSHADOW}/${outfile} ]]; then
        re2='^[<>][^<]*<cdchawthorne>|^[^<>]'
        diff_output="$(diff ${IRCPATH}/${outfile} ${IRCSHADOW}/${outfile})"
        [[ -z "$(grep -Ev ${re2} <<< ${diff_output})" ]] && continue
    fi
    mkdir -p "$(dirname ${IRCSHADOW}/${outfile})"
    cp ${IRCPATH}/${outfile} ${IRCSHADOW}/${outfile}
    channel="$(sed -re 's_\./[^/]*/([^/]*)/out$_\1_' <<< ${outfile})"
    if ! grep -F ${channel} ${UPDATED_FILES} &> /dev/null; then
        echo ${channel} >> ${UPDATED_FILES}
    fi
done
